<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="kr">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>관광지 정보</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Free HTML5 Website Template by FreeHTML5.co" />
    <meta name="keywords" content="free html5, free template, free bootstrap, free website template, html5, css3, mobile first, responsive" />
    <meta name="author" content="FreeHTML5.co" />

    <!-- 
	//////////////////////////////////////////////////////

	FREE HTML5 TEMPLATE 
	DESIGNED & DEVELOPED by FreeHTML5.co
		
	Website: 		http://freehtml5.co/
	Email: 			info@freehtml5.co
	Twitter: 		http://twitter.com/fh5co
	Facebook: 		https://www.facebook.com/fh5co

	//////////////////////////////////////////////////////
	-->

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- <link rel="shortcut icon" href="favicon.ico" /> -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet" />
    <!-- Naver Web Font -->
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-barun-gothic.css" rel="stylesheet" />

    <!-- Animate.css -->
    <link rel="stylesheet" href="../../css/animate.css" />
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="../../css/icomoon.css" />
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="../../css/bootstrap.css" />
    <!-- Flexslider  -->
    <link rel="stylesheet" href="../../css/flexslider.css" />
    <!-- Theme style  -->
    <link rel="stylesheet" href="../../css/style.css" />
    <!-- 이 파일의 style -->
    <link rel="stylesheet" href="./restaurants.css" />

    <!-- jQuery -->
    <script src="../../js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="../../js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="../../js/bootstrap.min.js"></script>
    <!-- Waypoints -->
    <script src="../../js/jquery.waypoints.min.js"></script>
    <!-- Flexslider -->
    <script src="../../js/jquery.flexslider-min.js"></script>

    <!-- MAIN JS -->
    <script src="../../js/main.js"></script>

    <!-- Modernizr JS -->
    <script src="../../js/modernizr-2.6.2.min.js"></script>

    <!-- 쿠키 관련 함수 -->
    <script src="./js/cookie.js"></script>
    <!-- 찜 목록 관련 함수 -->
    <script src="./js/restaurants.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
	<script src="js/respond.min.js"></s>
	<![endif]-->

    <script>
      // 앱 키
      const apiKey = "EmPrDl5kZrOzoYiaEQ1J%2BrysQf8dbws8ZMv4KCelNelSrm4hGQfxXmg2X6jumQex%2FRK72yCvA5fNzAs%2F9LFkpQ%3D%3D";
      // 메뉴를 출력할 element의 id 집합
      const selectElementIds = {
        area: "#area",
        sigungu: "#sigungu",
        cat3: "#cat3",
      };
      // 선택된 메뉴값, default : '' (전체)
      const selectedMenus = {
        area: "",
        sigungu: "",
        cat3: "",
      };
      // 페이지네이션에 필요한 값
      let pageNo = 1;
      let numOfRows = 12;
      let totalCount = 0;
      // 각 기능별 호출 api의 url 집합
      const urls = {
        list: function (areaCode, sigunguCode, cat3Code, pageNo) {
          return `http://apis.data.go.kr/B551011/KorService1/areaBasedList1?numOfRows=${numOfRows}&pageNo=${pageNo}&MobileOS=ETC&MobileApp=AppTest&ServiceKey=${apiKey}&listYN=Y&arrange=A&contentTypeId=12&areaCode=${areaCode}&sigunguCode=${sigunguCode}&cat1=A01&cat2=A0101&cat3=${cat3Code}&_type=json`;
        },
        area: `http://apis.data.go.kr/B551011/KorService1/areaCode1?ServiceKey=${apiKey}&numOfRows=17&pageNo=1&MobileOS=ETC&MobileApp=AppTest&_type=json`,
        sigungu: function (areaCode) {
          return `http://apis.data.go.kr/B551011/KorService1/areaCode1?ServiceKey=${apiKey}&areaCode=${areaCode}&numOfRows=25&pageNo=1&MobileOS=ETC&MobileApp=AppTest&_type=json`;
        },
        cat3: `http://apis.data.go.kr/B551011/KorService1/categoryCode1?ServiceKey=${apiKey}&cat1=A01&cat2=A0101&numOfRows=17&pageNo=1&MobileOS=ETC&MobileApp=AppTest&_type=json`,
        keyword: function (areaCode, sigunguCode, cat3Code, pageNo, keyword) {
          return `http://apis.data.go.kr/B551011/KorService1/searchKeyword1?ServiceKey=${apiKey}&listYN=Y&arrange=A&contentTypeId=12&areaCode=${areaCode}&sigunguCode=${sigunguCode}&cat1=A01&cat2=A0101&cat3=${cat3Code}&numOfRows=${numOfRows}&keyword=${keyword}&pageNo=1&MobileOS=ETC&MobileApp=AppTest&_type=json`;
        },
      };
      const favoritesState = {
        isOpened: false,
      };

      $(function () {
        $(".loading-indicator").hide();
        $(selectElementIds.sigungu).parent().hide();

        // 찜목록 그리기
        drawFavorites();

        // api 요청
        getRestaurantsList(pageNo);
        getMenuCode(urls.area, selectElementIds.area);
        getMenuCode(urls.cat3, selectElementIds.cat3);

        // ----- 이벤트 리스너 추가 --------------------------------------
        $(selectElementIds.area)
          .children()
          .change(function () {
            selectedMenus.area = $(this).val();
            console.log("광역시/시 코드 선택 : " + selectedMenus.area);
            if (selectedMenus.area != "") {
              getMenuCode(urls.sigungu(selectedMenus.area), selectElementIds.sigungu);
              $(selectElementIds.sigungu).parent().show();
            } else {
              $(selectElementIds.sigungu).parent().hide();
              $(selectElementIds.sigungu).html("");
              selectedMenus.sigungu = "";
            }
          });
        $(selectElementIds.sigungu).on("DOMNodeInserted", function () {
          // 시군구 div DOM 변경;
          $(selectElementIds.sigungu)
            .children()
            .change(function () {
              selectedMenus.sigungu = $(this).val();
              console.log("시/군/구 코드 선택 : " + selectedMenus.sigungu);
            });
        });
        $(selectElementIds.cat3)
          .children()
          .change(function () {
            selectedMenus.cat3 = $(this).val();
            console.log("소분류 코드 선택 : " + selectedMenus.cat3);
          });
        $("#search").click(function () {
          $(".wrapper-restaurants-list").html("");
          pageNo = 1;
          getRestaurantsList(pageNo);
        });
        $("#keyword").on("keyup", function (event) {
          if (event.keyCode == 13) {
            getRestaurantsList(pageNo);
          }
        });
        // 찜 목록 버튼 이벤트 리스너 추가
        $(".btn-toggle-favorite").click(function () {
          if (favoritesState.isOpened) {
            $("#favorites").css("right", "-300px");
            $(".favorites .btn-toggle-favorite").css("opacity", "0.7");
          } else {
            $("#favorites").css("right", "0");
            $(".favorites .btn-toggle-favorite").css("opacity", "1");
          }
          favoritesState.isOpened = !favoritesState.isOpened;
        });
        // ---------------------------------------------------------------
      });

      function getRestaurantsList(pageNo) {
        $(".loading-indicator").show();
        console.log("요청 url [목록]", urls.list(selectedMenus.area, selectedMenus.sigungu, selectedMenus.cat3));
        const keyword = $("#keyword").val();
        $.ajax({
          url:
            keyword == ""
              ? urls.list(selectedMenus.area, selectedMenus.sigungu, selectedMenus.cat3, pageNo)
              : urls.keyword(selectedMenus.area, selectedMenus.sigungu, selectedMenus.cat3, pageNo, keyword), // 데이터를 수신 받을 서버 주소
          type: "get", // 통신방식(GET, POST, PUT, DELETE)
          dataType: "json", // 수신 받을 데이터 타입
          async: false,
          success: function (data) {
            // 통신이 성공했을 때 호출되는 콜백함수
            console.log("[success]", data);
            parsingData(data);
          },
          err: function (err) {
            // 통신이 실패(부정적인 response) 했을 때 호출되는 콜백함수
            console.log("[error]" + err);
          },
          complete: function ({ responseText }) {
            // 통신이 완료되었을 때 호출 되는 콜백함수
            const responseXML = new DOMParser().parseFromString(responseText, "text/html");
            if (responseXML.getElementsByTagName("returnReasonCode").length > 0) {
              console.log(responseXML.getElementsByTagName("returnReasonCode")[0].outerText, responseXML.getElementsByTagName("errMsg")[0].outerText);
              showToast("[일시적인 에러] 잠시 후 다시 시도해주세요");
            }
            $(".loading-indicator").hide();
          },
        });

        function parsingData(restaurantsData) {
          const restaurantsArr = restaurantsData.response.body.items.item;
          // console.log(restaurantsArr);

          const totalCount = restaurantsData.response.body.totalCount;
          let output = "";
          if (totalCount > 0) {
            $.each(restaurantsArr, function (i, item) {
              const contentId = item.contentid;

              output += `<div class="items col-lg-3 col-sm-6 col-padding animate-box" data-animate-effect="fadeInLeft">`;
              output += `<div class="blog-entry" onclick="viewDetail('${contentId}');">`;
              output += `<a href="#" class="blog-img">`;
              output += `<img src="${
                item.firstimage != "" ? item.firstimage : item.firstimage2 != "" ? item.firstimage2 : "../../images/noimage_restaurants.png"
              }" class="img-responsive" alt="Free HTML5 Bootstrap Template by FreeHTML5.co" /></a>`;
              output += `<div class="desc">`;
              output += `<h3>`;
              output += `<a href="#" title="${item.title}">${item.title}</a>`;
              output += `</h3>`;
              output += `<p>${item.addr1}${item.addr2 != "" ? " " + item.addr2 : ""}</p>`;
              output += `<div class="desc-flex margin-bottom-0">`;
              output += `<span><small>등록일</small></span><span><small>${stringToDate(item.createdtime)}</small><span>`;
              output += `</div>`;
              output += `<div class="desc-flex">`;
              output += `<span><small>수정일</small></span><span><small>${stringToDate(item.modifiedtime)}</small></span>`;
              output += `</div>`;
              output += `<div class="desc-footer">`;
              output += `<a href="#" class="lead">자세히 보기 <i class="icon-arrow-right3"></i></a>`;
              output += `<i id="i${contentId}" class="icon-star3 favoriteIcon" onclick="toggleFavorites('${contentId}', '${item.title}', '${item.firstimage}');"></i>`;
              output += `</div>`;
              output += `</div>`;
              output += `</div>`;
              output += `</div>`;
            });
          }
          $(".wrapper-restaurants-list").html(output);

          updateFavoritesIcon();

          $("#totalCount").html(`총 ${totalCount}건의 정보가 검색되었습니다.`);

          const totalPage = Math.ceil(totalCount / numOfRows);
          // console.log(totalPage);
          let pageOutput = "";
          if (totalPage <= 10) {
            // 페이지가 10개 이하, 이전, 다음 없음
            for (let i = Math.floor(pageNo / 10) * 10 + 1; i <= totalPage; i++) {
              pageOutput += `<a href="#" class="btn btn-primary${i == pageNo ? " active" : ""}" id="${i}" onclick="pageControlHandler(this.id);">${i}</a>`;
            }
          } else if (totalPage - pageNo < 10) {
            // 마지막 페이지 구간, 다음 없음
            pageOutput += `<a href="#" class="btn btn-primary btn-page-prev" id="btnPrev" onclick="pageControlHandler(this.id);">이전</a>`;
            // console.log(Math.floor(pageNo / 10) * 10 + 1);
            // console.log(totalPage);
            for (let i = Math.floor(pageNo / 10) * 10 + 1; i <= totalPage; i++) {
              pageOutput += `<a href="#" class="btn btn-primary${i == pageNo ? " active" : ""}" id="${i}" onclick="pageControlHandler(this.id);">${i}</a>`;
            }
          } else {
            // 페이지가 10개 초과이고 마지막 구간도 아님, 이전, 다음 모두 존재
            if (pageNo > 10) {
              pageOutput += `<a href="#" class="btn btn-primary btn-page-prev" id="btnPrev" onclick="pageControlHandler(this.id);">이전</a>`;
            }
            for (let i = Math.floor(pageNo / 10) * 10 + 1; i <= Math.floor(pageNo / 10) * 10 + 10; i++) {
              pageOutput += `<a href="#" class="btn btn-primary${i == pageNo ? " active" : ""}" id="${i}" onclick="pageControlHandler(this.id);">${i}</a>`;
            }
            pageOutput += `<a href="#" class="btn btn-primary btn-page-next" id="btnNext" onclick="pageControlHandler(this.id);">다음</a>`;
          }
          $(".page").html(pageOutput);

          contentWayPoint();

          function contentWayPoint() {
            var i = 0;
            $(".animate-box").waypoint(
              function (direction) {
                if (direction === "down" && !$(this.element).hasClass("animated")) {
                  i++;

                  $(this.element).addClass("item-animate");
                  setTimeout(function () {
                    $("body .animate-box.item-animate").each(function (k) {
                      var el = $(this);
                      setTimeout(
                        function () {
                          var effect = el.data("animate-effect");
                          if (effect === "fadeIn") {
                            el.addClass("fadeIn animated");
                          } else if (effect === "fadeInLeft") {
                            el.addClass("fadeInLeft animated");
                          } else if (effect === "fadeInRight") {
                            el.addClass("fadeInRight animated");
                          } else {
                            el.addClass("fadeInUp animated");
                          }

                          el.removeClass("item-animate");
                        },
                        k * 200,
                        "easeInOutExpo"
                      );
                    });
                  }, 100);
                }
              },
              { offset: "85%" }
            );
          }
        }
      }

      function getMenuCode(url, eid) {
        $(".loading-indicator").show();
        console.log("요청 url [드랍메뉴]", url);
        $.ajax({
          url: url, // 데이터를 수신 받을 서버 주소
          type: "get", // 통신방식(GET, POST, PUT, DELETE)
          dataType: "json", // 수신 받을 데이터 타입
          async: false,
          success: function (data) {
            // 통신이 성공했을 때 호출되는 콜백함수
            console.log("[success]" + data);
            drawSelect(data, eid);
          },
          err: function (err) {
            console.log("[ajax error]" + err);
            // 통신이 실패(부정적인 response) 했을 때 호출되는 콜백함수
          },
          complete: function ({ responseText }) {
            // console.log("[complete]", responseText);
            // 통신이 완료되었을 때 호출 되는 콜백함수
            const responseXML = new DOMParser().parseFromString(responseText, "text/html");
            if (responseXML.getElementsByTagName("returnReasonCode").length > 0) {
              console.log(responseXML.getElementsByTagName("returnReasonCode")[0].outerText, responseXML.getElementsByTagName("errMsg")[0].outerText);
              showToast("[일시적인 에러] 잠시 후 다시 시도해주세요");
            }
            $(".loading-indicator").hide();
          },
        });
      }

      function drawSelect(data, eid) {
        let output = `<select>`;
        output += `<option value="">전체</option>`;
        $.each(data.response.body.items.item, function (i, item) {
          output += `<option value="${item.code}">${item.name}</option>`;
        });
        output += `</select>`;

        $(eid).html(output);
      }

      // api로 받은 데이터의 날짜값 parsing
      function stringToDate(str) {
        let year = str.substr(0, 4);
        let month = str.substr(4, 2);
        let date = str.substr(6, 2);
        let hour = str.substr(8, 2);
        let minute = str.substr(10, 2);
        let second = str.substr(12, 2);
        // console.log(year, month, date, hour, minute, second)
        return `${year}년 ${month}월 ${date}일 ${hour}:${minute}:${second}`;
      }

      // 페이지 버튼 (이전, 페이지숫자, 다음) 핸들러
      function pageControlHandler(id) {
        if (id == "btnPrev") {
          pageNo = Math.floor(pageNo / 10) * 10 - 1;
        } else if (id == "btnNext") {
          pageNo = Math.floor(pageNo / 10) * 10 + 10 + 1;
        } else {
          pageNo = Number(id);
        }
        // console.log("click :", pageNo);
        getRestaurantsList(pageNo);
      }
    </script>
  </head>
  <body>
    <div id="fh5co-page">
      <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
      <aside id="fh5co-aside" role="complementary" class="border js-fullheight">
        <h1 id="fh5co-logo"><a href="../../index.html">Goott Tour</a></h1>
        <nav id="fh5co-main-menu" role="navigation">
          <ul>
            <li><a href="../../index.html">Home</a></li>
            <li class="fh5co-active"><a href="../tour/list.html">Tour</a></li>
            <li><a href="../culture/list.html">Culture</a></li>
            <li><a href="../festival/list.html">Festival</a></li>
            <li><a href="../travel/list.html">Travel</a></li>
            <li><a href="../leisure/list.html">Leisure</a></li>
            <li><a href="../lodge/list.html">Lodge</a></li>
            <li><a href="../shopping/list.html">Shopping</a></li>
            <li><a href="../restaurants/list.html">Restaurants</a></li>
          </ul>
        </nav>

        <div class="fh5co-footer">
          <p>
            <small
              ><span>&copy; 2016 Blend Free HTML5. All Rights Reserved.</span>
              <span
                >Designed by
                <a href="http://freehtml5.co/" target="_blank">FreeHTML5.co</a>
              </span>
              <span>Demo Images: <a href="https://unsplash.com/" target="_blank">Unsplash</a></span></small
            >
          </p>
          <ul>
            <li>
              <a href="#"><i class="icon-facebook2"></i></a>
            </li>
            <li>
              <a href="#"><i class="icon-twitter2"></i></a>
            </li>
            <li>
              <a href="#"><i class="icon-instagram"></i></a>
            </li>
            <li>
              <a href="#"><i class="icon-linkedin2"></i></a>
            </li>
          </ul>
        </div>
      </aside>

      <div id="fh5co-main">
        <div class="fh5co-narrow-content">
          <h2 class="fh5co-heading animate-box" data-animate-effect="fadeInLeft">관광지</h2>
          <div class="fh5co-heading animate-box" data-animate-effect="fadeInLeft">
            <small>모양만 만들어 두기 위해 파라메터만 변경하여 음식점 페이지 코드 복사</small><br />
            <small>대분류 자연, 중분류 자연관광지 고정, 소분류만 선택 가능</small>
          </div>
          <div class="wrapper-category animate-box" data-animate-effect="fadeInLeft">
            <div>
              <small>광역시/시</small>
              <div id="area"></div>
            </div>
            <div>
              <small>시/군/구</small>
              <div id="sigungu"></div>
            </div>
            <div>
              <small>소분류</small>
              <div id="cat3"></div>
            </div>
            <div>
              <small>&nbsp;</small>
              <input type="text" id="keyword" placeholder="검색 키워드를 입력해주세요" />
            </div>
            <div>
              <small>&nbsp;</small>
              <a href="#" class="btn btn-primary" id="search">검색</a>
            </div>
            <div class="wrapper-total-count">
              <small>&nbsp;</small>
              <span id="totalCount"></span>
            </div>
          </div>
          <div class="row row-bottom-padded-md wrapper-restaurants-list"></div>
          <div class="page"></div>
        </div>
      </div>
      <div id="favorites" class="favorites">
        <div class="btn-toggle-favorite"><i class="icon-star3"></i></div>
        <div class="wrapper-favorites">
          <h3>My Favorites</h3>
          <ul id="favorites-list"></ul>
        </div>
      </div>
    </div>
    <div class="loading-indicator">
      <img src="../../images/loading_restaurants.gif" />
    </div>
  </body>
</html>
